{% extends "base.html" %}

{% block title %}
{% if song %}编辑歌曲{% else %}上传歌曲{% endif %} - 吃得好好，睡得饱饱
{% endblock %}

{% block content %}
<div class="upload-form">
    <h2>{% if song %}编辑歌曲{% else %}上传新歌曲{% endif %}</h2>

    <form method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="song_name">歌曲名 <span class="required">*</span></label>
            <input type="text" id="song_name" name="song_name"
                   value="{{ song.song_name if song else '' }}"
                   required maxlength="200" placeholder="请输入歌曲名称">
        </div>

        <div class="form-group">
            <label for="artist">艺术家</label>
            <input type="text" id="artist" name="artist"
                   value="{{ song.artist if song else '' }}"
                   maxlength="200" placeholder="可选，艺术家或原作者">
        </div>

        <div class="form-group">
            <label for="version">版本</label>
            <input type="text" id="version" name="version"
                   value="{{ song.version if song else '' }}"
                   maxlength="50" placeholder="如: 1.0, 2.1.3"
                   pattern="[0-9.]+" title="只能包含数字和点">
        </div>

        <div class="form-group">
            <label for="uploaded_by">上传者角色 <span class="required">*</span></label>
            <select id="uploaded_by" name="uploaded_by" required>
                <option value="">请选择角色</option>
                <option value="D" {% if song and song.uploaded_by == 'D' %}selected{% endif %}>D</option>
                <option value="M" {% if song and song.uploaded_by == 'M' %}selected{% endif %}>M</option>
                <option value="J" {% if song and song.uploaded_by == 'J' %}selected{% endif %}>J</option>
            </select>
        </div>

        <div class="form-group">
            <label for="notes">备注</label>
            <textarea id="notes" name="notes" rows="3" maxlength="500"
                      placeholder="可选，任何相关的备注信息">{{ song.notes if song else '' }}</textarea>
        </div>

        <div class="file-uploads">
            <div class="form-group">
                <label for="midi_file">
                    MIDI文件 {% if not song %}<span class="required">*</span>{% endif %}
                    <span class="file-info">(*.mid, 最大1MB)</span>
                </label>
                <input type="file" id="midi_file" name="midi_file"
                       accept=".mid,.midi" {% if not song %}required{% endif %}>
                {% if song and song.midi_filename %}
                    <div class="current-file">
                        当前文件: {{ song.midi_filename }}
                        {% if song.track_names %}
                            <br><small>音轨: {{ song.track_names|join(', ') }}</small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="source_file">
                    源文件 (可选)
                    <span class="file-info">(*.musz, 最大1MB)</span>
                </label>
                <input type="file" id="source_file" name="source_file" accept=".musz">
                {% if song and song.source_filename %}
                    <div class="current-file">当前文件: {{ song.source_filename }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="lyric_file">
                    歌词文件 (可选)
                    <span class="file-info">(*.lrc, 最大1MB)</span>
                </label>
                <input type="file" id="lyric_file" name="lyric_file" accept=".lrc">
                {% if song and song.lyric_filename %}
                    <div class="current-file">当前文件: {{ song.lyric_filename }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {% if song %}更新歌曲{% else %}上传歌曲{% endif %}
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">取消</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // File size validation
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.files[0] && this.files[0].size > 1024 * 1024) {
                alert('文件大小不能超过1MB');
                this.value = '';
            }
        });
    });

    // Version field validation
    const versionInput = document.getElementById('version');
    versionInput.addEventListener('input', function() {
        const value = this.value;
        if (value && !/^[0-9.]+$/.test(value)) {
            this.setCustomValidity('版本号只能包含数字和点');
        } else {
            this.setCustomValidity('');
        }
    });
});
</script>
{% endblock %}